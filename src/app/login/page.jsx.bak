'use client';

import { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import Headers from '@/components/Headers/page';
import Link from 'next/link';
import Footer from '@/components/Footer/page';

export default function Login() {
    const router = useRouter();
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loginError, setLoginError] = useState('');
    const [loading, setLoading] = useState(false);
    const [faceLoading, setFaceLoading] = useState(false);
    const [modelsLoaded, setModelsLoaded] = useState(false);
    const videoRef = useRef();

    // Check if user is already logged in on component mount
    useEffect(() => {
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (typeof window !== 'undefined' && loggedInUser) {
            const user = JSON.parse(loggedInUser);
            // CORREGIDO: Redirigir al panel correcto según el rol del usuario ya logueado.
            redirectByRole(user.rol);
        }
    }, [router]);

    useEffect(() => {
        const loadModels = async () => {
            try {
                const faceapi = await import('face-api.js');
                const MODEL_URL = '/models';
                
                setModelsLoaded(false);
                setLoginError('');
                
                console.log('Iniciando carga de modelos desde:', MODEL_URL);
                
                // Cargar los modelos uno por uno para mejor diagnóstico
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL)
                    .catch(e => { throw new Error('Error al cargar TinyFaceDetector: ' + e.message) });
                console.log('TinyFaceDetector cargado');
                
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
                    .catch(e => { throw new Error('Error al cargar FaceLandmark68Net: ' + e.message) });
                console.log('FaceLandmark68Net cargado');
                
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    .catch(e => { throw new Error('Error al cargar FaceRecognitionNet: ' + e.message) });
                console.log('FaceRecognitionNet cargado');
                
                await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
                    .catch(e => { throw new Error('Error al cargar SsdMobilenetv1: ' + e.message) });
                console.log('SsdMobilenetv1 cargado');
                
                setModelsLoaded(true);
                console.log('Todos los modelos cargados exitosamente');
            } catch (error) {
                console.error('Error detallado:', error);
                setLoginError(`Error al cargar los modelos de reconocimiento facial: ${error.message}`);
                setModelsLoaded(false);
            }
        };

        // Intentar cargar los modelos
        loadModels();

        // Limpieza al desmontar
        return () => {
            setModelsLoaded(false);
            setLoginError('');
        };
    }, []);

    const startFaceLogin = async () => {
        if (!modelsLoaded) {
            setLoginError("Por favor espere a que se carguen los modelos de reconocimiento facial.");
            return;
        }

        setFaceLoading(true);
        setLoginError('');

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            videoRef.current.srcObject = stream;

            // Esperar a que el video se cargue
            await new Promise((resolve) => {
                videoRef.current.onloadedmetadata = () => {
                    videoRef.current.play();
                    resolve();
                };
            });

            const faceapi = await import('face-api.js');
            
            // Detectar rostro y obtener descriptores
            const detection = await faceapi.detectSingleFace(
                videoRef.current,
                new faceapi.TinyFaceDetectorOptions()
            ).withFaceLandmarks().withFaceDescriptor();

            if (!detection) {
                throw new Error("No se detectó ningún rostro. Por favor, asegúrese de estar bien iluminado y mirando directamente a la cámara.");
            }

            // Enviar el descriptor facial al servidor para autenticación
            const response = await fetch('/api/auth/face-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    faceDescriptor: Array.from(detection.descriptor)
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || "Error en la autenticación facial.");
            }

            // Guardar la información del usuario y redirigir
            localStorage.setItem('loggedInUser', JSON.stringify(data.user));
            redirectByRole(data.user.rol);

        } catch (error) {
            setLoginError(error.message || "Error en el reconocimiento facial.");
        } finally {
            setFaceLoading(false);
            // Cerrar la cámara
            const stream = videoRef.current?.srcObject;
            stream?.getTracks().forEach(track => track.stop());
        }
    };
    const redirectByRole = (rol) => {
        const routes = {
            SUPERUSER: '/superUser',
            Administrador: '/admin', // Aseguramos que el rol esté bien escrito aquí
            Cliente: '/clientes',
        };
        router.push(routes[rol] || '/');
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoginError('');
        setLoading(true);

        if (!email.includes('@')) {
            setLoginError('El correo electrónico no es válido.');
            return;
        }

        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await res.json();
            if (!res.ok) {
                setLoginError(data.message || 'Error al iniciar sesión');
                return;
            }

            const user = data.user;
            localStorage.setItem('loggedInUser', JSON.stringify({ id: user.id, nombre: user.nombre, rol: user.rol }));
            alert(`¡Bienvenido, ${user.nombre}! Redirigiendo...`);
            redirectByRole(user.rol);
        } catch (err) {
            setLoginError(err.message || 'Error al conectar con el servidor');
        } finally {
            setLoading(false);
        }
    };

    const stopCamera = () => {
        if (videoRef.current && videoRef.current.srcObject) {
            videoRef.current.srcObject.getTracks().forEach(track => track.stop());
        }
        setFaceLoading(false);
    };

    return (
        <div className="min-h-screen flex flex-col bg-gradient-to-br from-blue-100 via-yellow-100 to-pink-100">
            <div className="w-full">
                <Headers />
            </div>
            <div className="flex-1 flex items-center justify-center my-10">
                <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md animate-fade-in">
                    {faceLoading && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50">
                            <h2 className="text-white text-2xl mb-4">Mirando a la cámara...</h2>
                            <video ref={videoRef} width="480" height="360" autoPlay muted className="rounded-lg"></video>
                            <button onClick={stopCamera} className="mt-4 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600">
                                Cancelar
                            </button>
                        </div>
                    )}
                    <div className="flex flex-col items-center mb-6">
                        <div className="bg-blue-100 rounded-full p-4 mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-12 h-12 text-blue-500">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 20.25a8.25 8.25 0 1115 0v.75A2.25 2.25 0 0117.25 23h-10.5A2.25 2.25 0 014.5 21v-.75z" />
                            </svg>
                        </div>
                        <h1 className="text-3xl font-bold text-center text-gray-800">Iniciar Sesión</h1>
                    </div>

                    {loginError && (
                        <div className="mb-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700">
                            <p>{loginError}</p>
                        </div>
                    )}

                    <div className="flex flex-col space-y-4">
                        <button
                            onClick={() => startFaceLogin()}
                            type="button"
                            disabled={!modelsLoaded || faceLoading}
                            className={`flex items-center justify-center px-4 py-3 rounded-lg ${
                                modelsLoaded 
                                    ? 'bg-green-500 hover:bg-green-600' 
                                    : loginError 
                                        ? 'bg-red-500'
                                        : 'bg-gray-400'
                            } text-white transition-colors duration-200 w-full`}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            {modelsLoaded 
                                ? 'Iniciar con Face ID' 
                                : loginError 
                                    ? 'Error al cargar Face ID' 
                                    : 'Cargando Face ID...'}
                        </button>

                        {loginError && loginError.includes('reconocimiento facial') && (
                            <div className="p-3 bg-red-50 border-l-4 border-red-500 text-red-700">
                                <p className="font-bold">Error al cargar Face ID</p>
                                <p className="text-sm">{loginError}</p>
                                <button 
                                    onClick={() => window.location.reload()} 
                                    className="mt-2 text-sm text-blue-600 hover:text-blue-800 underline"
                                >
                                    Intentar cargar de nuevo
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="relative my-6">
                        <div className="absolute inset-0 flex items-center">
                            <div className="w-full border-t border-gray-300"></div>
                        </div>
                        <div className="relative flex justify-center text-sm">
                            <span className="px-2 bg-white text-gray-500">O ingresa con tus credenciales</span>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-6">
                    <div>
                        <label htmlFor="email" className="block text-gray-700 text-sm font-bold mb-2">
                            Correo Electrónico
                        </label>
                        <input
                            type="email"
                            id="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="shadow appearance-none border border-blue-200 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-300"
                            required
                        />
                    </div>
                    <div>
                        <label htmlFor="password" className="block text-gray-700 text-sm font-bold mb-2">
                            Contraseña
                        </label>
                        <input
                            type="password"
                            id="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="shadow appearance-none border border-yellow-200 rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-yellow-300"
                            required
                        />
                        {loginError && (
                            <p className="text-red-500 text-xs italic mt-2 text-center">{loginError}</p>
                        )}
                    </div>
                    <div className="text-right text-sm">
                        <Link href="/forgot-password" className="font-medium text-blue-500 hover:text-blue-600">
                            ¿Olvidaste tu contraseña?
                        </Link>
                    </div>
                    <button
                        type="submit"
                        className="bg-gradient-to-r from-blue-500 via-yellow-400 to-pink-400 hover:from-blue-600 hover:via-yellow-500 hover:to-pink-500 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300 w-full flex justify-center items-center disabled:bg-gray-400 transition-all duration-200"
                        disabled={loading}
                    >
                        {loading ? (
                            <span className="flex items-center">
                                <svg className="animate-spin h-5 w-5 mr-2 text-white" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" />
                                </svg>
                                Cargando...
                            </span>
                        ) : 'Ingresar'}
                    </button>
                </form>
                <div className="text-center mt-6">


                <div className="text-center mt-6">
                    <p className="text-sm text-gray-600">
                        ¿No tienes una cuenta?{' '}
                        <Link href="/register" className="font-medium text-blue-500 hover:text-blue-600">
                            Regístrate aquí
                        </Link>
                    </p>
                </div>
                </div>
            </div>
            <div className="w-full mt-8">
                <Footer />
            </div>
            <style jsx>{`
                .animate-fade-in {
                    animation: fadeIn 0.7s ease;
                }
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `}</style>
        </div>
    );
